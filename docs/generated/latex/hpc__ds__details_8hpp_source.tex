\hypertarget{hpc__ds__details_8hpp_source}{}\doxysection{hpc\+\_\+ds\+\_\+details.\+hpp}
\label{hpc__ds__details_8hpp_source}\index{/home/somik/CBIA/hpc-\/datastore-\/cpp/src/hpc\_ds\_details.hpp@{/home/somik/CBIA/hpc-\/datastore-\/cpp/src/hpc\_ds\_details.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#include "{}hpc\_ds\_structs.hpp"{}}}
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include <Poco/JSON/Object.h>}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include <Poco/JSON/Parser.h>}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#include <Poco/Net/HTTPClientSession.h>}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#include <Poco/Net/HTTPMessage.h>}}
\DoxyCodeLine{7 \textcolor{preprocessor}{\#include <Poco/Net/HTTPRequest.h>}}
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <Poco/Net/HTTPResponse.h>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <Poco/URI.h>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <i3d/image3d.h>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <i3d/vector3d.h>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <optional>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <source\_location>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <span>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include <string>}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <type\_traits>}}
\DoxyCodeLine{17 \textcolor{comment}{/* ==================== DETAILS HEADERS ============================ */}}
\DoxyCodeLine{18 }
\DoxyCodeLine{19 \textcolor{keyword}{namespace }datastore \{}
\DoxyCodeLine{20 \textcolor{keyword}{namespace }details \{}
\DoxyCodeLine{21 \textcolor{preprocessor}{\#ifdef DATASTORE\_NDEBUG}}
\DoxyCodeLine{22 \textcolor{keyword}{constexpr} \textcolor{keyword}{inline} \textcolor{keywordtype}{bool} debug = \textcolor{keyword}{false};}
\DoxyCodeLine{23 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#ifdef NDEBUG}}
\DoxyCodeLine{25 \textcolor{keyword}{constexpr} \textcolor{keyword}{inline} \textcolor{keywordtype}{bool} debug = \textcolor{keyword}{false};}
\DoxyCodeLine{26 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{27 \textcolor{keyword}{constexpr} \textcolor{keyword}{inline} \textcolor{keywordtype}{bool} debug = \textcolor{keyword}{true};}
\DoxyCodeLine{28 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{29 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{30 }
\DoxyCodeLine{39 \textcolor{keyword}{inline} std::string}
\DoxyCodeLine{40 get\_dataset\_url(\textcolor{keyword}{const} std::string\& ip, \textcolor{keywordtype}{int} port, \textcolor{keyword}{const} std::string\& uuid);}
\DoxyCodeLine{41 }
\DoxyCodeLine{48 \textcolor{keyword}{inline} DatasetProperties get\_dataset\_properties(\textcolor{keyword}{const} std::string\& dataset\_url);}
\DoxyCodeLine{49 }
\DoxyCodeLine{57 \textcolor{keyword}{inline} i3d::Vector3d<int> get\_block\_dimensions(\textcolor{keyword}{const} DatasetProperties\& props,}
\DoxyCodeLine{58                                                i3d::Vector3d<int> resolution);}
\DoxyCodeLine{59 }
\DoxyCodeLine{71 \textcolor{keyword}{inline} \textcolor{keywordtype}{bool} check\_block\_coords(\textcolor{keyword}{const} std::vector<i3d::Vector3d<int>>\& coords,}
\DoxyCodeLine{72                                i3d::Vector3d<int> img\_dim,}
\DoxyCodeLine{73                                i3d::Vector3d<int> block\_dim);}
\DoxyCodeLine{74 }
\DoxyCodeLine{89 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{90 \textcolor{keywordtype}{bool} check\_offset\_coords(\textcolor{keyword}{const} std::vector<i3d::Vector3d<int>>\& offsets,}
\DoxyCodeLine{91                          \textcolor{keyword}{const} std::vector<i3d::Vector3d<int>>\& coords,}
\DoxyCodeLine{92                          \textcolor{keyword}{const} i3d::Image3d<T>\& img,}
\DoxyCodeLine{93                          i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{94                          i3d::Vector3d<int> img\_dim);}
\DoxyCodeLine{95 \textcolor{keyword}{namespace }data\_manip \{}
\DoxyCodeLine{96 \textcolor{keyword}{inline} \textcolor{keywordtype}{int} get\_block\_data\_size(i3d::Vector3d<int> block\_size,}
\DoxyCodeLine{97                                \textcolor{keyword}{const} std::string\& voxel\_type);}
\DoxyCodeLine{98 }
\DoxyCodeLine{99 \textcolor{keyword}{inline} i3d::Vector3d<int> get\_block\_size(i3d::Vector3d<int> coord,}
\DoxyCodeLine{100                                          i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{101                                          i3d::Vector3d<int> img\_dim);}
\DoxyCodeLine{102 }
\DoxyCodeLine{103 \textcolor{keyword}{inline} \textcolor{keywordtype}{int} get\_linear\_index(i3d::Vector3d<int> coord,}
\DoxyCodeLine{104                             i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{105                             \textcolor{keyword}{const} std::string\& voxel\_type);}
\DoxyCodeLine{106 }
\DoxyCodeLine{107 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{108 T get\_elem\_at(std::span<const char> data,}
\DoxyCodeLine{109               \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{110               \textcolor{keywordtype}{int} index);}
\DoxyCodeLine{111 }
\DoxyCodeLine{112 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{113 T get\_elem\_at(std::span<const char> data,}
\DoxyCodeLine{114               \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{115               i3d::Vector3d<int> coord,}
\DoxyCodeLine{116               i3d::Vector3d<int> block\_dim);}
\DoxyCodeLine{117 }
\DoxyCodeLine{118 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{119 \textcolor{keywordtype}{void} set\_elem\_at(std::span<char> data,}
\DoxyCodeLine{120                  \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{121                  \textcolor{keywordtype}{int} index,}
\DoxyCodeLine{122                  T elem);}
\DoxyCodeLine{123 }
\DoxyCodeLine{124 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{125 \textcolor{keywordtype}{void} set\_elem\_at(std::span<char> data,}
\DoxyCodeLine{126                  \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{127                  i3d::Vector3d<int> coord,}
\DoxyCodeLine{128                  i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{129                  T elem);}
\DoxyCodeLine{130 }
\DoxyCodeLine{140 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{141 \textcolor{keywordtype}{void} read\_data(std::span<const char> data,}
\DoxyCodeLine{142                \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{143                i3d::Image3d<T>\& dest,}
\DoxyCodeLine{144                i3d::Vector3d<int> offset);}
\DoxyCodeLine{145 }
\DoxyCodeLine{156 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{157 \textcolor{keywordtype}{void} write\_data(\textcolor{keyword}{const} i3d::Image3d<T>\& src,}
\DoxyCodeLine{158                 i3d::Vector3d<int> offset,}
\DoxyCodeLine{159                 std::span<char> data,}
\DoxyCodeLine{160                 \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{161                 i3d::Vector3d<int> block\_size);}
\DoxyCodeLine{162 \} \textcolor{comment}{// namespace data\_manip}}
\DoxyCodeLine{163 }
\DoxyCodeLine{164 \textcolor{keyword}{namespace }log \{}
\DoxyCodeLine{171 \textcolor{keyword}{inline} \textcolor{keywordtype}{void} \_log(\textcolor{keyword}{const} std::string\& msg, \textcolor{keyword}{const} std::source\_location\& location);}
\DoxyCodeLine{172 }
\DoxyCodeLine{179 \textcolor{keyword}{inline} \textcolor{keywordtype}{void}}
\DoxyCodeLine{180 info(\textcolor{keyword}{const} std::string\& msg,}
\DoxyCodeLine{181      \textcolor{keyword}{const} std::source\_location\& location = std::source\_location::current());}
\DoxyCodeLine{182 }
\DoxyCodeLine{189 \textcolor{keyword}{inline} \textcolor{keywordtype}{void}}
\DoxyCodeLine{190 warning(\textcolor{keyword}{const} std::string\& msg,}
\DoxyCodeLine{191         \textcolor{keyword}{const} std::source\_location\& location = std::source\_location::current());}
\DoxyCodeLine{192 }
\DoxyCodeLine{199 \textcolor{keyword}{inline} \textcolor{keywordtype}{void}}
\DoxyCodeLine{200 error(\textcolor{keyword}{const} std::string\& msg,}
\DoxyCodeLine{201       \textcolor{keyword}{const} std::source\_location\& location = std::source\_location::current());}
\DoxyCodeLine{202 \} \textcolor{comment}{// namespace log}}
\DoxyCodeLine{203 }
\DoxyCodeLine{204 \textcolor{comment}{/* Helpers to parse Dataset Properties from JSON */}}
\DoxyCodeLine{205 \textcolor{keyword}{namespace }props\_parser \{}
\DoxyCodeLine{206 \textcolor{keyword}{using namespace }Poco::JSON;}
\DoxyCodeLine{207 }
\DoxyCodeLine{208 \textcolor{keyword}{template} <cnpts::Basic T>}
\DoxyCodeLine{209 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name);}
\DoxyCodeLine{210 }
\DoxyCodeLine{211 \textcolor{keyword}{template} <cnpts::Vector3d T>}
\DoxyCodeLine{212 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name);}
\DoxyCodeLine{213 }
\DoxyCodeLine{214 \textcolor{keyword}{template} <cnpts::Vector T>}
\DoxyCodeLine{215 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name);}
\DoxyCodeLine{216 }
\DoxyCodeLine{217 \textcolor{keyword}{template} <cnpts::ResolutionUnit T>}
\DoxyCodeLine{218 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name);}
\DoxyCodeLine{219 }
\DoxyCodeLine{220 \textcolor{keyword}{template} <cnpts::Optional T>}
\DoxyCodeLine{221 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name);}
\DoxyCodeLine{222 }
\DoxyCodeLine{223 \textcolor{keyword}{inline} std::vector<std::map<std::string, i3d::Vector3d<int>>>}
\DoxyCodeLine{224 get\_resolution\_levels(Object::Ptr root);}
\DoxyCodeLine{225 }
\DoxyCodeLine{226 \} \textcolor{comment}{// namespace props\_parser}}
\DoxyCodeLine{227 }
\DoxyCodeLine{228 \textcolor{comment}{/* Helpers providing requests functionality */}}
\DoxyCodeLine{229 \textcolor{keyword}{namespace }requests \{}
\DoxyCodeLine{230 \textcolor{keyword}{inline} std::string session\_url\_request(\textcolor{keyword}{const} std::string\& ds\_url,}
\DoxyCodeLine{231                                        i3d::Vector3d<int> resolution,}
\DoxyCodeLine{232                                        \textcolor{keyword}{const} std::string\& version);}
\DoxyCodeLine{233 }
\DoxyCodeLine{234 \textcolor{keyword}{inline} std::pair<std::vector<char>, Poco::Net::HTTPResponse>}
\DoxyCodeLine{235 make\_request(\textcolor{keyword}{const} std::string\& url,}
\DoxyCodeLine{236              \textcolor{keyword}{const} std::string\& type = Poco::Net::HTTPRequest::HTTP\_GET,}
\DoxyCodeLine{237              \textcolor{keyword}{const} std::vector<char>\& data = \{\},}
\DoxyCodeLine{238              \textcolor{keyword}{const} std::map<std::string, std::string>\& headers = \{\});}
\DoxyCodeLine{239 \} \textcolor{comment}{// namespace requests}}
\DoxyCodeLine{240 \} \textcolor{comment}{// namespace details}}
\DoxyCodeLine{241 \} \textcolor{comment}{// namespace datastore}}
\DoxyCodeLine{242 }
\DoxyCodeLine{243 \textcolor{comment}{/* ================= IMPLEMENTATION FOLLOWS ======================== */}}
\DoxyCodeLine{244 \textcolor{keyword}{namespace }datastore \{}
\DoxyCodeLine{245 \textcolor{keyword}{namespace }details \{}
\DoxyCodeLine{246 }
\DoxyCodeLine{247 \textcolor{comment}{/* inline */} std::string}
\DoxyCodeLine{248 get\_dataset\_url(\textcolor{keyword}{const} std::string\& ip, \textcolor{keywordtype}{int} port, \textcolor{keyword}{const} std::string\& uuid) \{}
\DoxyCodeLine{249     std::string out;}
\DoxyCodeLine{250     \textcolor{keywordflow}{if} (!ip.starts\_with(\textcolor{stringliteral}{"{}http://"{}}))}
\DoxyCodeLine{251         out = \textcolor{stringliteral}{"{}https://"{}};}
\DoxyCodeLine{252     \textcolor{keywordflow}{return} out + fmt::format(\textcolor{stringliteral}{"{}\{\}:\{\}/datasets/\{\}"{}}, ip, port, uuid);}
\DoxyCodeLine{253 \}}
\DoxyCodeLine{254 }
\DoxyCodeLine{255 \textcolor{keyword}{inline} DatasetProperties}
\DoxyCodeLine{256 get\_dataset\_properties(\textcolor{keyword}{const} std::string\& dataset\_url) \{}
\DoxyCodeLine{257     \textcolor{keyword}{using namespace }Poco::JSON;}
\DoxyCodeLine{258 }
\DoxyCodeLine{259     \textcolor{comment}{/* Fetch JSON from server */}}
\DoxyCodeLine{260     \textcolor{keyword}{auto} [data, response] = requests::make\_request(dataset\_url);}
\DoxyCodeLine{261     std::string json\_str(data.begin(), data.end());}
\DoxyCodeLine{262 }
\DoxyCodeLine{263     \textcolor{keywordtype}{int} res\_code = response.getStatus();}
\DoxyCodeLine{264     \textcolor{keywordflow}{if} (res\_code != 200)}
\DoxyCodeLine{265         log::warning(fmt::format(}
\DoxyCodeLine{266             \textcolor{stringliteral}{"{}Request ended with code: \{\}. json may not be valid"{}}, res\_code));}
\DoxyCodeLine{267 }
\DoxyCodeLine{268     log::info(\textcolor{stringliteral}{"{}Parsing dataset properties from JSON string"{}});}
\DoxyCodeLine{269     Parser parser;}
\DoxyCodeLine{270     Poco::Dynamic::Var result = parser.parse(json\_str);}
\DoxyCodeLine{271 }
\DoxyCodeLine{272     DatasetProperties props;}
\DoxyCodeLine{273     \textcolor{keyword}{auto} root = result.extract<Object::Ptr>();}
\DoxyCodeLine{274 }
\DoxyCodeLine{275     \textcolor{keyword}{using namespace }props\_parser;}
\DoxyCodeLine{276 }
\DoxyCodeLine{277     \textcolor{comment}{/* Parse elements from JSON */}}
\DoxyCodeLine{278 }
\DoxyCodeLine{279     props.uuid = get\_elem<std::string>(root, \textcolor{stringliteral}{"{}uuid"{}});}
\DoxyCodeLine{280     props.voxel\_type = get\_elem<std::string>(root, \textcolor{stringliteral}{"{}voxelType"{}});}
\DoxyCodeLine{281     props.dimensions = get\_elem<i3d::Vector3d<int>>(root, \textcolor{stringliteral}{"{}dimensions"{}});}
\DoxyCodeLine{282     props.channels = get\_elem<int>(root, \textcolor{stringliteral}{"{}channels"{}});}
\DoxyCodeLine{283     props.angles = get\_elem<int>(root, \textcolor{stringliteral}{"{}angles"{}});}
\DoxyCodeLine{284     props.transformations =}
\DoxyCodeLine{285         get\_elem<std::optional<std::string>>(root, \textcolor{stringliteral}{"{}transformations"{}});}
\DoxyCodeLine{286     props.voxel\_unit = get\_elem<std::string>(root, \textcolor{stringliteral}{"{}voxelUnit"{}});}
\DoxyCodeLine{287     props.voxel\_resolution =}
\DoxyCodeLine{288         get\_elem<std::optional<i3d::Vector3d<double>>>(root, \textcolor{stringliteral}{"{}voxelResolution"{}});}
\DoxyCodeLine{289     props.timepoint\_resolution =}
\DoxyCodeLine{290         get\_elem<std::optional<ResolutionUnit>>(root, \textcolor{stringliteral}{"{}timepointResolution"{}});}
\DoxyCodeLine{291     props.channel\_resolution =}
\DoxyCodeLine{292         get\_elem<std::optional<ResolutionUnit>>(root, \textcolor{stringliteral}{"{}channelResolution"{}});}
\DoxyCodeLine{293     props.angle\_resolution =}
\DoxyCodeLine{294         get\_elem<std::optional<ResolutionUnit>>(root, \textcolor{stringliteral}{"{}angleResolution"{}});}
\DoxyCodeLine{295     props.compression = get\_elem<std::string>(root, \textcolor{stringliteral}{"{}compression"{}});}
\DoxyCodeLine{296     props.resolution\_levels = get\_resolution\_levels(root);}
\DoxyCodeLine{297     props.versions = get\_elem<std::vector<int>>(root, \textcolor{stringliteral}{"{}versions"{}});}
\DoxyCodeLine{298     props.label = get\_elem<std::string>(root, \textcolor{stringliteral}{"{}label"{}});}
\DoxyCodeLine{299     props.view\_registrations =}
\DoxyCodeLine{300         get\_elem<std::optional<std::string>>(root, \textcolor{stringliteral}{"{}viewRegistrations"{}});}
\DoxyCodeLine{301     props.timepoint\_ids = get\_elem<std::vector<int>>(root, \textcolor{stringliteral}{"{}timepointIds"{}});}
\DoxyCodeLine{302 }
\DoxyCodeLine{303     log::info(\textcolor{stringliteral}{"{}Parsing has finished"{}});}
\DoxyCodeLine{304     \textcolor{keywordflow}{return} props;}
\DoxyCodeLine{305 \}}
\DoxyCodeLine{306 }
\DoxyCodeLine{307 \textcolor{comment}{/* inline */} i3d::Vector3d<int>}
\DoxyCodeLine{308 get\_block\_dimensions(\textcolor{keyword}{const} DatasetProperties\& props,}
\DoxyCodeLine{309                      i3d::Vector3d<int> resolution) \{}
\DoxyCodeLine{310     \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}\& res\_level : props.resolution\_levels)}
\DoxyCodeLine{311         \textcolor{keywordflow}{if} (res\_level.at(\textcolor{stringliteral}{"{}resolutions"{}}) == resolution)}
\DoxyCodeLine{312             \textcolor{keywordflow}{return} res\_level.at(\textcolor{stringliteral}{"{}blockDimensions"{}});}
\DoxyCodeLine{313 }
\DoxyCodeLine{314     log::error(fmt::format(\textcolor{stringliteral}{"{}Dimensions for resolution \{\} not found"{}},}
\DoxyCodeLine{315                            to\_string(resolution)));}
\DoxyCodeLine{316     \textcolor{keywordflow}{return} \{-\/1, -\/1, -\/1\};}
\DoxyCodeLine{317 \}}
\DoxyCodeLine{318 }
\DoxyCodeLine{319 \textcolor{comment}{/* inline */} \textcolor{keywordtype}{bool}}
\DoxyCodeLine{320 check\_block\_coords(\textcolor{keyword}{const} std::vector<i3d::Vector3d<int>>\& coords,}
\DoxyCodeLine{321                    i3d::Vector3d<int> img\_dim,}
\DoxyCodeLine{322                    i3d::Vector3d<int> block\_dim) \{}
\DoxyCodeLine{323     \textcolor{comment}{/* Act as NOOP if not in debug */}}
\DoxyCodeLine{324     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (!debug)}
\DoxyCodeLine{325         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{326 }
\DoxyCodeLine{327     log::info(\textcolor{stringliteral}{"{}Checking validity of given block coordinates"{}});}
\DoxyCodeLine{328 }
\DoxyCodeLine{329     \textcolor{keywordflow}{for} (i3d::Vector3d<int> coord : coords)}
\DoxyCodeLine{330         \textcolor{keywordflow}{if} (data\_manip::get\_block\_size(coord, block\_dim, img\_dim) ==}
\DoxyCodeLine{331             i3d::Vector3d(0, 0, 0)) \{}
\DoxyCodeLine{332             log::error(fmt::format(\textcolor{stringliteral}{"{}Block coordinate \{\} is out of valid range"{}},}
\DoxyCodeLine{333                                    to\_string(coord)));}
\DoxyCodeLine{334 }
\DoxyCodeLine{335             \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{336         \}}
\DoxyCodeLine{337     log::info(\textcolor{stringliteral}{"{}Check successfullly finished"{}});}
\DoxyCodeLine{338     \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{339 \}}
\DoxyCodeLine{340 }
\DoxyCodeLine{341 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{342 \textcolor{keywordtype}{bool} check\_offset\_coords(\textcolor{keyword}{const} std::vector<i3d::Vector3d<int>>\& offsets,}
\DoxyCodeLine{343                          \textcolor{keyword}{const} std::vector<i3d::Vector3d<int>>\& coords,}
\DoxyCodeLine{344                          \textcolor{keyword}{const} i3d::Image3d<T>\& img,}
\DoxyCodeLine{345                          i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{346                          i3d::Vector3d<int> img\_dim) \{}
\DoxyCodeLine{347     \textcolor{comment}{/* Act as NOOP if not in debug */}                       }
\DoxyCodeLine{348     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (!debug)}
\DoxyCodeLine{349         \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{350 }
\DoxyCodeLine{351     \textcolor{keywordflow}{if} (offsets.size() != coords.size())}
\DoxyCodeLine{352         \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{353 }
\DoxyCodeLine{354     log::info(\textcolor{stringliteral}{"{}Checking validity of given offset coordinates"{}});}
\DoxyCodeLine{355 }
\DoxyCodeLine{356     \textcolor{keywordflow}{for} (std::size\_t i = 0; i < coords.size(); ++i) \{}
\DoxyCodeLine{357         \textcolor{keyword}{auto}\& coord = coords[i];}
\DoxyCodeLine{358         \textcolor{keyword}{auto}\& offset = offsets[i];}
\DoxyCodeLine{359 }
\DoxyCodeLine{360         i3d::Vector3d<int> block\_size =}
\DoxyCodeLine{361             data\_manip::get\_block\_size(coord, block\_dim, img\_dim);}
\DoxyCodeLine{362         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; ++i)}
\DoxyCodeLine{363             \textcolor{keywordflow}{if} (!(0 <= coord[i] \&\&}
\DoxyCodeLine{364                   std::size\_t(offset[i] + block\_size[i]) <= img.GetSize()[i])) \{}
\DoxyCodeLine{365                 log::error(}
\DoxyCodeLine{366                     fmt::format(\textcolor{stringliteral}{"{}Offset coordinate \{\} is out of valid range"{}},}
\DoxyCodeLine{367                                 to\_string(coord)));}
\DoxyCodeLine{368 }
\DoxyCodeLine{369                 \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{370             \}}
\DoxyCodeLine{371     \}}
\DoxyCodeLine{372     log::info(\textcolor{stringliteral}{"{}Check successfullly finished"{}});}
\DoxyCodeLine{373     \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{374 \}}
\DoxyCodeLine{375 }
\DoxyCodeLine{376 \textcolor{keyword}{namespace }data\_manip \{}
\DoxyCodeLine{377 \textcolor{comment}{/* inline */} \textcolor{keywordtype}{int} get\_block\_data\_size(i3d::Vector3d<int> block\_size,}
\DoxyCodeLine{378                                      \textcolor{keyword}{const} std::string\& voxel\_type) \{}
\DoxyCodeLine{379 }
\DoxyCodeLine{380     \textcolor{keywordtype}{int} elem\_size = type\_byte\_size.at(voxel\_type);}
\DoxyCodeLine{381     \textcolor{keywordflow}{return} block\_size.x * block\_size.y * block\_size.z * elem\_size + 12;}
\DoxyCodeLine{382 \}}
\DoxyCodeLine{383 }
\DoxyCodeLine{384 \textcolor{comment}{/* inline */} i3d::Vector3d<int> get\_block\_size(i3d::Vector3d<int> coord,}
\DoxyCodeLine{385                                                i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{386                                                i3d::Vector3d<int> img\_dim) \{}
\DoxyCodeLine{387     i3d::Vector3d<int> start = (coord * block\_dim);}
\DoxyCodeLine{388     i3d::Vector3d<int> end = (coord + 1) * block\_dim;}
\DoxyCodeLine{389 }
\DoxyCodeLine{390     i3d::Vector3d<int> out;}
\DoxyCodeLine{391     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; ++i) \{}
\DoxyCodeLine{392         out[i] =}
\DoxyCodeLine{393             std::max(0, std::min(img\_dim[i], end[i]) -\/ std::max(start[i], 0));}
\DoxyCodeLine{394     \}}
\DoxyCodeLine{395     \textcolor{keywordflow}{return} out;}
\DoxyCodeLine{396 \}}
\DoxyCodeLine{397 }
\DoxyCodeLine{398 \textcolor{comment}{/* inline */} \textcolor{keywordtype}{int} get\_linear\_index(i3d::Vector3d<int> coord,}
\DoxyCodeLine{399                                   i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{400                                   \textcolor{keyword}{const} std::string\& voxel\_type) \{}
\DoxyCodeLine{401     \textcolor{keywordtype}{int} elem\_size = type\_byte\_size.at(voxel\_type);}
\DoxyCodeLine{402 }
\DoxyCodeLine{403     \textcolor{keywordflow}{return} 12 +                                   \textcolor{comment}{// header\_offset}}
\DoxyCodeLine{404            (coord.z * block\_dim.x * block\_dim.y + \textcolor{comment}{// Main axis}}
\DoxyCodeLine{405             coord.y * block\_dim.x +               \textcolor{comment}{// secondary axis}}
\DoxyCodeLine{406             coord.x) *                            \textcolor{comment}{// last axis}}
\DoxyCodeLine{407                elem\_size;                         \textcolor{comment}{// byte size}}
\DoxyCodeLine{408 \}}
\DoxyCodeLine{409 }
\DoxyCodeLine{410 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{411 T get\_elem\_at(std::span<const char> data,}
\DoxyCodeLine{412               \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{413               \textcolor{keywordtype}{int} index) \{}
\DoxyCodeLine{414     \textcolor{keywordtype}{int} elem\_size = type\_byte\_size.at(voxel\_type);}
\DoxyCodeLine{415 }
\DoxyCodeLine{416     std::array<char, \textcolor{keyword}{sizeof}(T)> buffer\{\};}
\DoxyCodeLine{417     std::copy\_n(data.begin() + index,      \textcolor{comment}{// source start}}
\DoxyCodeLine{418                 elem\_size,                 \textcolor{comment}{// count}}
\DoxyCodeLine{419                 buffer.end() -\/ elem\_size); \textcolor{comment}{// dest start}}
\DoxyCodeLine{420 }
\DoxyCodeLine{421     std::ranges::reverse(buffer);}
\DoxyCodeLine{422 }
\DoxyCodeLine{423     \textcolor{keywordflow}{return} *\textcolor{keyword}{reinterpret\_cast<}T*\textcolor{keyword}{>}(\&buffer[0]);}
\DoxyCodeLine{424 \}}
\DoxyCodeLine{425 }
\DoxyCodeLine{426 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{427 T get\_elem\_at(std::span<const char> data,}
\DoxyCodeLine{428               \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{429               i3d::Vector3d<int> coord,}
\DoxyCodeLine{430               i3d::Vector3d<int> block\_dim) \{}
\DoxyCodeLine{431 }
\DoxyCodeLine{432     \textcolor{keywordtype}{int} index = get\_linear\_index(coord, block\_dim, voxel\_type);}
\DoxyCodeLine{433     \textcolor{keywordflow}{return} get\_elem\_at<T>(data, voxel\_type, index);}
\DoxyCodeLine{434 \}}
\DoxyCodeLine{435 }
\DoxyCodeLine{436 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{437 \textcolor{keywordtype}{void} set\_elem\_at(std::span<char> data,}
\DoxyCodeLine{438                  \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{439                  \textcolor{keywordtype}{int} index,}
\DoxyCodeLine{440                  T elem) \{}
\DoxyCodeLine{441     \textcolor{keywordtype}{int} elem\_size = type\_byte\_size.at(voxel\_type);}
\DoxyCodeLine{442 }
\DoxyCodeLine{443     \textcolor{keyword}{auto} buffer = *\textcolor{keyword}{reinterpret\_cast<}std::array<\textcolor{keywordtype}{char}, sizeof(T)\textcolor{keyword}{>}*>(\&elem);}
\DoxyCodeLine{444     std::ranges::reverse(buffer);}
\DoxyCodeLine{445 }
\DoxyCodeLine{446     std::copy\_n(buffer.end() -\/ elem\_size, \textcolor{comment}{// source start}}
\DoxyCodeLine{447                 elem\_size,                \textcolor{comment}{// count}}
\DoxyCodeLine{448                 data.begin() + index);    \textcolor{comment}{// dest start}}
\DoxyCodeLine{449 \}}
\DoxyCodeLine{450 }
\DoxyCodeLine{451 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{452 \textcolor{keywordtype}{void} set\_elem\_at(std::span<char> data,}
\DoxyCodeLine{453                  \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{454                  i3d::Vector3d<int> coord,}
\DoxyCodeLine{455                  i3d::Vector3d<int> block\_dim,}
\DoxyCodeLine{456                  T elem) \{}
\DoxyCodeLine{457     \textcolor{keywordtype}{int} index = get\_linear\_index(coord, block\_dim, voxel\_type);}
\DoxyCodeLine{458     set\_elem\_at(data, voxel\_type, index, elem);}
\DoxyCodeLine{459 \}}
\DoxyCodeLine{460 }
\DoxyCodeLine{461 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{462 \textcolor{keywordtype}{void} read\_data(std::span<const char> data,}
\DoxyCodeLine{463                \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{464                i3d::Image3d<T>\& dest,}
\DoxyCodeLine{465                i3d::Vector3d<int> offset) \{}
\DoxyCodeLine{466     i3d::Vector3d<int> block\_dim;}
\DoxyCodeLine{467     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < 3; ++i)}
\DoxyCodeLine{468         block\_dim[i] = get\_elem\_at<int>(data, \textcolor{stringliteral}{"{}uint32"{}}, i * 4);}
\DoxyCodeLine{469 }
\DoxyCodeLine{470     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < block\_dim.x; ++x)}
\DoxyCodeLine{471         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < block\_dim.y; ++y)}
\DoxyCodeLine{472             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} z = 0; z < block\_dim.z; ++z)}
\DoxyCodeLine{473                 dest.SetVoxel(}
\DoxyCodeLine{474                     x + offset.x, y + offset.y, z + offset.z,}
\DoxyCodeLine{475                     get\_elem\_at<T>(data, voxel\_type, \{x, y, z\}, block\_dim));}
\DoxyCodeLine{476 \}}
\DoxyCodeLine{477 }
\DoxyCodeLine{478 \textcolor{keyword}{template} <\textcolor{keyword}{typename} T>}
\DoxyCodeLine{479 \textcolor{keywordtype}{void} write\_data(\textcolor{keyword}{const} i3d::Image3d<T>\& src,}
\DoxyCodeLine{480                 i3d::Vector3d<int> offset,}
\DoxyCodeLine{481                 std::span<char> data,}
\DoxyCodeLine{482                 \textcolor{keyword}{const} std::string\& voxel\_type,}
\DoxyCodeLine{483                 i3d::Vector3d<int> block\_size) \{}
\DoxyCodeLine{484     set\_elem\_at(data, \textcolor{stringliteral}{"{}uint32"{}}, 0, block\_size.x);}
\DoxyCodeLine{485     set\_elem\_at(data, \textcolor{stringliteral}{"{}uint32"{}}, 4, block\_size.y);}
\DoxyCodeLine{486     set\_elem\_at(data, \textcolor{stringliteral}{"{}uint32"{}}, 8, block\_size.z);}
\DoxyCodeLine{487 }
\DoxyCodeLine{488     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} x = 0; x < block\_size.x; ++x)}
\DoxyCodeLine{489         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} y = 0; y < block\_size.y; ++y)}
\DoxyCodeLine{490             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} z = 0; z < block\_size.z; ++z)}
\DoxyCodeLine{491                 set\_elem\_at(}
\DoxyCodeLine{492                     data, voxel\_type, \{x, y, z\}, block\_size,}
\DoxyCodeLine{493                     src.GetVoxel(x + offset.x, y + offset.y, z + offset.z));}
\DoxyCodeLine{494 \}}
\DoxyCodeLine{495 \} \textcolor{comment}{// namespace data\_manip}}
\DoxyCodeLine{496 }
\DoxyCodeLine{497 \textcolor{keyword}{namespace }log \{}
\DoxyCodeLine{498 \textcolor{comment}{/* inline */} \textcolor{keywordtype}{void} \_log(\textcolor{keyword}{const} std::string\& msg,}
\DoxyCodeLine{499                        \textcolor{keyword}{const} std::string\& type,}
\DoxyCodeLine{500                        \textcolor{keyword}{const} std::source\_location\& location) \{}
\DoxyCodeLine{501     \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr} (!debug)}
\DoxyCodeLine{502         \textcolor{keywordflow}{return};}
\DoxyCodeLine{503 }
\DoxyCodeLine{504     std::cout << fmt::format(\textcolor{stringliteral}{"{}[\{\}] \{\} at row \{\}:\(\backslash\)n\{\} \(\backslash\)n\(\backslash\)n"{}}, type,}
\DoxyCodeLine{505                              location.function\_name(), location.line(), msg);}
\DoxyCodeLine{506     \textcolor{keywordflow}{if} (type.find(\textcolor{stringliteral}{"{}ERROR"{}}) != std::string::npos)}
\DoxyCodeLine{507         std::cout << std::flush;}
\DoxyCodeLine{508 \}}
\DoxyCodeLine{509 }
\DoxyCodeLine{510 \textcolor{comment}{/* inline */} \textcolor{keywordtype}{void} info(\textcolor{keyword}{const} std::string\& msg,}
\DoxyCodeLine{511                        \textcolor{keyword}{const} std::source\_location\&}
\DoxyCodeLine{512                            location \textcolor{comment}{/* = std::source\_location::current() */}) \{}
\DoxyCodeLine{513     \_log(msg, \textcolor{stringliteral}{"{}INFO"{}}, location);}
\DoxyCodeLine{514 \}}
\DoxyCodeLine{515 }
\DoxyCodeLine{516 \textcolor{comment}{/* inline */} \textcolor{keywordtype}{void}}
\DoxyCodeLine{517 warning(\textcolor{keyword}{const} std::string\& msg,}
\DoxyCodeLine{518         \textcolor{keyword}{const} std::source\_location\&}
\DoxyCodeLine{519             location \textcolor{comment}{/* = std::source\_location::current() */}) \{}
\DoxyCodeLine{520     \_log(msg, \textcolor{stringliteral}{"{}WARNING"{}}, location);}
\DoxyCodeLine{521 \}}
\DoxyCodeLine{522 }
\DoxyCodeLine{523 \textcolor{comment}{/* inline */} \textcolor{keywordtype}{void} error(\textcolor{keyword}{const} std::string\& msg,}
\DoxyCodeLine{524                         \textcolor{keyword}{const} std::source\_location\&}
\DoxyCodeLine{525                             location \textcolor{comment}{/* = std::source\_location::current() */}) \{}
\DoxyCodeLine{526     \_log(msg, \textcolor{stringliteral}{"{}ERROR"{}}, location);}
\DoxyCodeLine{527 \}}
\DoxyCodeLine{528 \} \textcolor{comment}{// namespace log}}
\DoxyCodeLine{529 }
\DoxyCodeLine{530 \textcolor{keyword}{namespace }props\_parser \{}
\DoxyCodeLine{531 }
\DoxyCodeLine{532 \textcolor{keyword}{template} <cnpts::Basic T>}
\DoxyCodeLine{533 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name) \{}
\DoxyCodeLine{534     \textcolor{keywordflow}{if} (!root-\/>has(name)) \{}
\DoxyCodeLine{535         log::warning(fmt::format(\textcolor{stringliteral}{"{}\{\} was not found"{}}, name));}
\DoxyCodeLine{536         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{537     \}}
\DoxyCodeLine{538     \textcolor{keywordflow}{return} root-\/>getValue<T>(name);}
\DoxyCodeLine{539 \}}
\DoxyCodeLine{540 }
\DoxyCodeLine{541 \textcolor{keyword}{template} <cnpts::Vector3d T>}
\DoxyCodeLine{542 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name) \{}
\DoxyCodeLine{543     \textcolor{keyword}{using} V = \textcolor{keyword}{decltype}(T\{\}.x);}
\DoxyCodeLine{544     \textcolor{keywordflow}{if} (!root-\/>has(name)) \{}
\DoxyCodeLine{545         log::warning(fmt::format(\textcolor{stringliteral}{"{}\{\} were not found"{}}, name));}
\DoxyCodeLine{546         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{547     \}}
\DoxyCodeLine{548 }
\DoxyCodeLine{549     Array::Ptr values = root-\/>getArray(name);}
\DoxyCodeLine{550     \textcolor{keywordflow}{if} (values-\/>size() != 3) \{}
\DoxyCodeLine{551         log::warning(\textcolor{stringliteral}{"{}Incorrect number of dimensions"{}});}
\DoxyCodeLine{552         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{553     \}}
\DoxyCodeLine{554 }
\DoxyCodeLine{555     T out;}
\DoxyCodeLine{556     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i = 0; i < 3; ++i)}
\DoxyCodeLine{557         out[i] = values-\/>getElement<V>(i);}
\DoxyCodeLine{558 }
\DoxyCodeLine{559     \textcolor{keywordflow}{return} out;}
\DoxyCodeLine{560 \}}
\DoxyCodeLine{561 }
\DoxyCodeLine{562 \textcolor{keyword}{template} <cnpts::Vector T>}
\DoxyCodeLine{563 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name) \{}
\DoxyCodeLine{564     \textcolor{keyword}{using} V = \textcolor{keyword}{typename} T::value\_type;}
\DoxyCodeLine{565     \textcolor{keywordflow}{if} (!root-\/>has(name)) \{}
\DoxyCodeLine{566         log::warning(fmt::format(\textcolor{stringliteral}{"{}\{\} were not found"{}}, name));}
\DoxyCodeLine{567         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{568     \}}
\DoxyCodeLine{569 }
\DoxyCodeLine{570     Array::Ptr values = root-\/>getArray(name);}
\DoxyCodeLine{571     std::size\_t count = values-\/>size();}
\DoxyCodeLine{572 }
\DoxyCodeLine{573     T out(count);}
\DoxyCodeLine{574     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i = 0; i < count; ++i)}
\DoxyCodeLine{575         out[i] = values-\/>getElement<V>(i);}
\DoxyCodeLine{576 }
\DoxyCodeLine{577     \textcolor{keywordflow}{return} out;}
\DoxyCodeLine{578 \}}
\DoxyCodeLine{579 }
\DoxyCodeLine{580 \textcolor{keyword}{template} <cnpts::ResolutionUnit T>}
\DoxyCodeLine{581 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name) \{}
\DoxyCodeLine{582     \textcolor{keywordflow}{if} (!root-\/>has(name)) \{}
\DoxyCodeLine{583         log::warning(fmt::format(\textcolor{stringliteral}{"{}\{\} was not found"{}}, name));}
\DoxyCodeLine{584         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{585     \}}
\DoxyCodeLine{586 }
\DoxyCodeLine{587     Object::Ptr res\_ptr = root-\/>getObject(name);}
\DoxyCodeLine{588     ResolutionUnit res;}
\DoxyCodeLine{589 }
\DoxyCodeLine{590     \textcolor{keywordflow}{if} (res\_ptr-\/>has(\textcolor{stringliteral}{"{}value"{}})) \{}
\DoxyCodeLine{591         res.value = res\_ptr-\/>getValue<\textcolor{keywordtype}{double}>(\textcolor{stringliteral}{"{}value"{}});}
\DoxyCodeLine{592     \}}
\DoxyCodeLine{593 }
\DoxyCodeLine{594     \textcolor{keywordflow}{if} (res\_ptr-\/>has(\textcolor{stringliteral}{"{}unit"{}})) \{}
\DoxyCodeLine{595         res.unit = res\_ptr-\/>getValue<std::string>(\textcolor{stringliteral}{"{}unit"{}});}
\DoxyCodeLine{596     \}}
\DoxyCodeLine{597 }
\DoxyCodeLine{598     \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{599 \}}
\DoxyCodeLine{600 }
\DoxyCodeLine{601 \textcolor{keyword}{template} <cnpts::Optional T>}
\DoxyCodeLine{602 T get\_elem(Object::Ptr root, \textcolor{keyword}{const} std::string\& name) \{}
\DoxyCodeLine{603     \textcolor{keywordflow}{if} (!root-\/>has(name)) \{}
\DoxyCodeLine{604         log::warning(fmt::format(\textcolor{stringliteral}{"{}\{\} were not found"{}}, name));}
\DoxyCodeLine{605         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{606     \}}
\DoxyCodeLine{607 }
\DoxyCodeLine{608     \textcolor{keywordflow}{if} (root-\/>isNull(name))}
\DoxyCodeLine{609         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{610 }
\DoxyCodeLine{611     T out;}
\DoxyCodeLine{612     out = get\_elem<typename T::value\_type>(root, name);}
\DoxyCodeLine{613     \textcolor{keywordflow}{return} out;}
\DoxyCodeLine{614 \}}
\DoxyCodeLine{615 }
\DoxyCodeLine{616 \textcolor{comment}{/* inline */} std::vector<std::map<std::string, i3d::Vector3d<int>>>}
\DoxyCodeLine{617 get\_resolution\_levels(Object::Ptr root) \{}
\DoxyCodeLine{618     std::string name = \textcolor{stringliteral}{"{}resolutionLevels"{}};}
\DoxyCodeLine{619 }
\DoxyCodeLine{620     \textcolor{keywordflow}{if} (!root-\/>has(name)) \{}
\DoxyCodeLine{621         log::warning(\textcolor{stringliteral}{"{}resolutionLevels were not found"{}});}
\DoxyCodeLine{622         \textcolor{keywordflow}{return} \{\};}
\DoxyCodeLine{623     \}}
\DoxyCodeLine{624 }
\DoxyCodeLine{625     std::vector<std::map<std::string, i3d::Vector3d<int>>> out;}
\DoxyCodeLine{626 }
\DoxyCodeLine{627     Array::Ptr array = root-\/>getArray(name);}
\DoxyCodeLine{628     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} i = 0; i < array-\/>size(); ++i) \{}
\DoxyCodeLine{629         std::map<std::string, i3d::Vector3d<int>> map;}
\DoxyCodeLine{630         Object::Ptr map\_ptr = array-\/>getObject(i);}
\DoxyCodeLine{631 }
\DoxyCodeLine{632         \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto}\& name : map\_ptr-\/>getNames()) \{}
\DoxyCodeLine{633             map[name] = get\_elem<i3d::Vector3d<int>>(map\_ptr, name);}
\DoxyCodeLine{634         \}}
\DoxyCodeLine{635 }
\DoxyCodeLine{636         out.push\_back(map);}
\DoxyCodeLine{637     \}}
\DoxyCodeLine{638 }
\DoxyCodeLine{639     \textcolor{keywordflow}{return} out;}
\DoxyCodeLine{640 \}}
\DoxyCodeLine{641 }
\DoxyCodeLine{642 \} \textcolor{comment}{// namespace props\_parser}}
\DoxyCodeLine{643 }
\DoxyCodeLine{644 \textcolor{keyword}{namespace }requests \{}
\DoxyCodeLine{645 \textcolor{comment}{/* inline */} std::string session\_url\_request(\textcolor{keyword}{const} std::string\& ds\_url,}
\DoxyCodeLine{646                                              i3d::Vector3d<int> resolution,}
\DoxyCodeLine{647                                              \textcolor{keyword}{const} std::string\& version) \{}
\DoxyCodeLine{648 }
\DoxyCodeLine{649     log::info(}
\DoxyCodeLine{650         fmt::format(\textcolor{stringliteral}{"{}Obtaining session url for resolution: \{\}, version: \{\}"{}},}
\DoxyCodeLine{651                     to\_string(resolution), version));}
\DoxyCodeLine{652     std::string req\_url =}
\DoxyCodeLine{653         fmt::format(\textcolor{stringliteral}{"{}\{\}/\{\}/\{\}/\{\}/\{\}/read-\/write"{}}, ds\_url, resolution.x,}
\DoxyCodeLine{654                     resolution.y, resolution.z, version);}
\DoxyCodeLine{655 }
\DoxyCodeLine{656     \textcolor{keyword}{auto} [\_, response] = make\_request(req\_url);}
\DoxyCodeLine{657 }
\DoxyCodeLine{658     \textcolor{keywordtype}{int} res\_code = response.getStatus();}
\DoxyCodeLine{659     \textcolor{keywordflow}{if} (res\_code != 307)}
\DoxyCodeLine{660         log::warning(fmt::format(}
\DoxyCodeLine{661             \textcolor{stringliteral}{"{}Request ended with status: \{\}, redirection may be incorrect"{}},}
\DoxyCodeLine{662             res\_code));}
\DoxyCodeLine{663 }
\DoxyCodeLine{664     \textcolor{keywordflow}{return} response.get(\textcolor{stringliteral}{"{}Location"{}});}
\DoxyCodeLine{665 \}}
\DoxyCodeLine{666 }
\DoxyCodeLine{667 \textcolor{comment}{/* inline */} std::pair<std::vector<char>, Poco::Net::HTTPResponse>}
\DoxyCodeLine{668 make\_request(\textcolor{keyword}{const} std::string\& url,}
\DoxyCodeLine{669              \textcolor{keyword}{const} std::string\& type \textcolor{comment}{/*  = Poco::Net::HTTPRequest::HTTP\_GET */},}
\DoxyCodeLine{670              \textcolor{keyword}{const} std::vector<char>\& data \textcolor{comment}{/*  = \{\} */},}
\DoxyCodeLine{671              \textcolor{keyword}{const} std::map<std::string, std::string>\& headers \textcolor{comment}{/* = \{\} */}) \{}
\DoxyCodeLine{672     Poco::URI uri(url);}
\DoxyCodeLine{673     std::string path(uri.getPathAndQuery());}
\DoxyCodeLine{674 }
\DoxyCodeLine{675     Poco::Net::HTTPClientSession session(uri.getHost(), uri.getPort());}
\DoxyCodeLine{676 }
\DoxyCodeLine{677     Poco::Net::HTTPRequest request(type, path,}
\DoxyCodeLine{678                                    Poco::Net::HTTPMessage::HTTP\_1\_1);}
\DoxyCodeLine{679 }
\DoxyCodeLine{680     \textcolor{keywordflow}{for} (\textcolor{keyword}{auto}\& [key, value] : headers)}
\DoxyCodeLine{681         request.set(key, value);}
\DoxyCodeLine{682 }
\DoxyCodeLine{683     request.setContentLength(data.size());}
\DoxyCodeLine{684 }
\DoxyCodeLine{685     log::info(fmt::format(\textcolor{stringliteral}{"{}Sending \{\} request to url: \{\}"{}}, type, url));}
\DoxyCodeLine{686     std::ostream\& os = session.sendRequest(request);}
\DoxyCodeLine{687     \textcolor{keywordflow}{for} (\textcolor{keywordtype}{char} ch : data)}
\DoxyCodeLine{688         os << ch;}
\DoxyCodeLine{689 }
\DoxyCodeLine{690     Poco::Net::HTTPResponse response;}
\DoxyCodeLine{691     std::istream\& rs = session.receiveResponse(response);}
\DoxyCodeLine{692 }
\DoxyCodeLine{693     std::vector<char> out\{std::istreambuf\_iterator<char>(rs),}
\DoxyCodeLine{694                           std::istreambuf\_iterator<char>()\};}
\DoxyCodeLine{695 }
\DoxyCodeLine{696     log::info(fmt::format(}
\DoxyCodeLine{697         \textcolor{stringliteral}{"{}Fetched response with status: \{\}, reason: \{\}, content size: \{\}"{}},}
\DoxyCodeLine{698         response.getStatus(), response.getReason(), out.size()));}
\DoxyCodeLine{699 }
\DoxyCodeLine{700     \textcolor{keywordflow}{return} \{out, response\};}
\DoxyCodeLine{701 \}}
\DoxyCodeLine{702 }
\DoxyCodeLine{703 \} \textcolor{comment}{// namespace requests}}
\DoxyCodeLine{704 \} \textcolor{comment}{// namespace details}}
\DoxyCodeLine{705 \} \textcolor{comment}{// namespace datastore}}

\end{DoxyCode}
